name: Docker Multiplatform Build

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Read the current version
      id: get_version
      run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

    - name: Increment the version
      id: increment_version
      run: |
        current_version=$(cat VERSION)
        IFS='.' read -r -a version_parts <<< "$current_version"
        version_parts[2]=$((version_parts[2] + 1))
        new_version="${version_parts[0]}.${version_parts[1]}.${version_parts[2]}"
        echo $new_version > VERSION
        echo "new_version=$new_version" >> $GITHUB_OUTPUT

    - name: Commit the new version
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git add VERSION
        git commit -m "Increment version to ${{ steps.increment_version.outputs.new_version }}"
        git push

    - name: Build and push Docker image (multiplatform)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          athrvk/calibre-puppeteer-base:${{ steps.increment_version.outputs.new_version }}
          athrvk/calibre-puppeteer-base:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: Verification step
      run: |
        # Run Calibre version command to verify installation (amd64 only for verification)
        docker run --rm --platform linux/amd64 athrvk/calibre-puppeteer-base:${{ steps.increment_version.outputs.new_version }} ebook-convert --version
